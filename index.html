<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時貴賓名單</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden md:flex">

        <!-- 左側：貴賓登記區 -->
        <div class="md:w-1/2 p-8 md:p-10 flex flex-col justify-center bg-gray-50 border-r border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">貴賓登記</h1>
            <p class="text-gray-500 mb-8 text-center">請填寫您的單位、職稱與姓名</p>
            
            <form id="visitor-form" class="space-y-6">
                <div>
                    <label for="custom-id" class="block text-sm font-medium text-gray-700 mb-1">共同資料庫 ID</label>
                    <input type="text" id="custom-id" required placeholder="例如：2024活動或團隊代碼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                    <input type="text" id="unit" required placeholder="例如：Google 台灣" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">職稱</label>
                    <input type="text" id="title" required placeholder="例如：軟體工程師" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="name" for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="name" required placeholder="例如：王小明" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-transform duration-200 transform hover:scale-105">
                    提交
                </button>
            </form>
        </div>

        <!-- 右側：貴賓列表 -->
        <div class="md:w-1/2 p-8 md:p-10 bg-white">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center sm:text-left mb-4 sm:mb-0">即時貴賓列表</h2>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button id="download-list" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        下載名冊
                    </button>
                    <button id="reset-list" class="flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        重設名單
                    </button>
                </div>
            </div>
            
            <!-- 貴賓列表容器 -->
            <div id="visitor-list" class="space-y-4">
                <p id="loading-message" class="text-gray-500 text-center">載入中...</p>
            </div>
            <div id="status-message" class="mt-4 p-3 rounded-lg text-sm text-center font-medium hidden"></div>

            <!-- 新增顯示連線資訊的區塊 -->
            <div class="mt-8 pt-4 border-t border-gray-200 text-center">
                <p class="text-gray-400 text-xs mb-1">連線資訊 (供偵錯使用)</p>
                <div class="bg-gray-50 p-3 rounded-lg text-xs font-mono text-gray-600">
                    <p>App ID: <span id="display-app-id">...</span></p>
                    <p>資料庫 ID: <span id="display-custom-id">...</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定義彈窗 -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-xs w-full mx-4 text-center">
            <p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="alert-ok-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">確定</button>
        </div>
    </div>

    <!-- Firebase 腳本 -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // These variables are automatically provided by the Canvas environment.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, visitorsData = [];
        const visitorForm = document.getElementById('visitor-form');
        const visitorList = document.getElementById('visitor-list');
        const loadingMessage = document.getElementById('loading-message');
        const statusMessage = document.getElementById('status-message');
        const displayAppId = document.getElementById('display-app-id');
        const displayCustomId = document.getElementById('display-custom-id');
        const customIdInput = document.getElementById('custom-id');
        const downloadButton = document.getElementById('download-list');
        const resetButton = document.getElementById('reset-list');
        let isOnlineMode = false;
        let currentCustomId = null;

        // Custom alert and confirm popups to replace browser native ones
        function showAlert(message) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            const modal = document.createElement('div');
            modal.className = 'bg-white p-6 rounded-lg shadow-xl max-w-xs w-full mx-4 text-center';
            const msg = document.createElement('p');
            msg.className = 'text-lg font-semibold text-gray-800 mb-4';
            msg.textContent = message;
            const okBtn = document.createElement('button');
            okBtn.className = 'px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors';
            okBtn.textContent = '確定';
            okBtn.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(msg);
            modal.appendChild(okBtn);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            statusMessage.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
        }

        function clearStatus() {
            statusMessage.classList.add('hidden');
        }

        /**
         * Converts a timestamp to a localized date string.
         * @param {object} timestamp - Firestore Timestamp object or a number.
         * @returns {string} Formatted date string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) {
                return 'N/A';
            }
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        /**
         * Renders the guest list.
         * @param {Array<object>} visitors - An array of visitor data.
         */
        function renderVisitors(visitors) {
            visitorList.innerHTML = '';
            if (visitors.length === 0) {
                visitorList.innerHTML = `<p class="text-gray-500 text-center">目前沒有貴賓</p>`;
                return;
            }
            const sortedVisitors = visitors.sort((a, b) => {
                if (a.visited !== b.visited) {
                    return a.visited ? 1 : -1;
                }
                if (a.timestamp && b.timestamp) {
                    const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB.getTime() - dateA.getTime();
                }
                return 0;
            });
            sortedVisitors.forEach(visitor => {
                const visitorItem = document.createElement('div');
                visitorItem.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm transition-transform duration-200 hover:scale-[1.01]';
                const visitorInfo = `
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-semibold text-gray-800 truncate">${visitor.name}</p>
                        <p class="text-sm text-gray-500 truncate">${visitor.unit} / ${visitor.title}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatTimestamp(visitor.timestamp)}</p>
                    </div>
                `;
                const statusButton = `
                    <button data-doc-id="${visitor.id}" data-visited="${visitor.visited}" class="toggle-status px-4 py-2 ml-4 rounded-full font-medium text-sm transition-colors duration-200
                        ${visitor.visited ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${visitor.visited ? '已介紹' : '尚未介紹'}
                    </button>
                `;
                visitorItem.innerHTML = visitorInfo + statusButton;
                visitorList.appendChild(visitorItem);
            });
            document.querySelectorAll('.toggle-status').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.docId;
                    const isVisited = e.target.dataset.visited === 'true';
                    if (isOnlineMode) {
                        try {
                            const docRef = doc(db, `artifacts/${appId}/public/data/${currentCustomId}`, docId);
                            await setDoc(docRef, { visited: !isVisited }, { merge: true });
                        } catch (error) {
                            console.error("Error updating status: ", error);
                            showAlert("更新狀態時發生錯誤。");
                        }
                    } else {
                        const visitorToUpdate = visitorsData.find(v => v.id === docId);
                        if (visitorToUpdate) {
                            visitorToUpdate.visited = !isVisited;
                            saveLocalData();
                            renderVisitors(visitorsData);
                        }
                    }
                });
            });
        }
        
        // Local storage functions
        function loadLocalData() {
            if (!currentCustomId) {
                visitorsData = [];
                renderVisitors(visitorsData);
                return;
            }
            const localStorageKey = `guest_list_${appId}_${currentCustomId}`;
            const data = localStorage.getItem(localStorageKey);
            visitorsData = data ? JSON.parse(data) : [];
            renderVisitors(visitorsData);
        }

        function saveLocalData() {
            if (!currentCustomId) return;
            const localStorageKey = `guest_list_${appId}_${currentCustomId}`;
            localStorage.setItem(localStorageKey, JSON.stringify(visitorsData));
        }

        /**
         * Downloads the guest list as a CSV file.
         */
        function downloadGuestList() {
            if (visitorsData.length === 0) {
                showAlert("目前沒有貴賓資料可以下載。");
                return;
            }
            const header = ["單位", "職稱", "姓名", "抵達時間", "介紹狀態"];
            const csv = visitorsData.map(v => 
                `"${v.unit}","${v.title}","${v.name}","${formatTimestamp(v.timestamp)}","${v.visited ? '已介紹' : '尚未介紹'}"`
            ).join('\n');
            const finalCsv = `${header.join(",")}\n${csv}`;
            const bom = '\uFEff';
            const blob = new Blob([bom + finalCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            link.setAttribute("href", url);
            link.setAttribute("download", `貴賓名冊_${dateStr}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Resets the guest list (deletes all data).
         */
        async function resetGuestList() {
            if (visitorsData.length === 0) {
                showAlert("目前沒有貴賓資料可以重設。");
                return;
            }
            const showCustomConfirm = () => {
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                const modal = document.createElement('div');
                modal.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4';
                const message = document.createElement('p');
                message.className = 'text-lg font-semibold text-gray-800 mb-4 text-center';
                message.textContent = "此操作將會重置名單，並永久刪除所有資料，請慎重選擇。";
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-center space-x-4';
                const confirmButton = document.createElement('button');
                confirmButton.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors';
                confirmButton.textContent = "確定重置";
                const cancelButton = document.createElement('button');
                cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors';
                cancelButton.textContent = "取消";
                return new Promise((resolve) => {
                    confirmButton.onclick = () => {
                        document.body.removeChild(overlay);
                        resolve(true);
                    };
                    cancelButton.onclick = () => {
                        document.body.removeChild(overlay);
                        resolve(false);
                    };
                    buttonContainer.appendChild(confirmButton);
                    buttonContainer.appendChild(cancelButton);
                    modal.appendChild(message);
                    modal.appendChild(buttonContainer);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                });
            };
            if (!(await showCustomConfirm())) {
                return;
            }
            if (isOnlineMode) {
                const visitorsCollection = collection(db, `artifacts/${appId}/public/data/${currentCustomId}`);
                const snapshot = await getDocs(visitorsCollection);
                const batch = writeBatch(db);
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                try {
                    await batch.commit();
                    showAlert("貴賓名單已成功重設。");
                } catch (error) {
                    console.error("重設名單時發生錯誤: ", error);
                    showAlert("重設名單時發生錯誤。");
                }
            } else {
                localStorage.removeItem(`guest_list_${appId}_${currentCustomId}`);
                visitorsData = [];
                renderVisitors(visitorsData);
                showAlert("貴賓名單已成功重設。");
            }
        }

        // Firebase initialization and authentication
        async function initializeFirebase() {
            setLogLevel('Debug');
            loadingMessage.textContent = '嘗試連線到共通資料庫...';
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    throw new Error("Invalid Firebase configuration provided by the environment.");
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase authenticated successfully. User ID: ", auth.currentUser.uid);
                isOnlineMode = true;
                setStatus("成功連線到共通資料庫，名單將會即時同步！");
                displayAppId.textContent = appId;
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingMessage.textContent = `連線失敗，自動切換至單機模式...`;
                isOnlineMode = false;
                setStatus("❗ 連線失敗，目前為單機模式，名單不會同步。", true);
                displayAppId.textContent = appId;
            }
            // Initial data load after Firebase is ready (or fails)
            loadingMessage.textContent = '請輸入資料庫 ID 以載入名單...';
            displayCustomId.textContent = 'N/A';
        }
        
        /**
         * Starts listening for visitor data changes from Firestore based on the custom ID.
         * @param {string} id - The custom ID for the collection.
         */
        function startListeningForVisitors(id) {
            const visitorsCollection = collection(db, `artifacts/${appId}/public/data/${id}`);
            const q = query(visitorsCollection);
            onSnapshot(q, (snapshot) => {
                visitorsData = [];
                snapshot.forEach((doc) => {
                    visitorsData.push({ id: doc.id, ...doc.data() });
                });
                renderVisitors(visitorsData);
            }, (error) => {
                console.error("Error listening to visitors data:", error);
                showAlert("載入資料時發生錯誤。");
            });
        }

        // Handle form submission
        visitorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const unit = document.getElementById('unit').value.trim();
            const title = document.getElementById('title').value.trim();
            const name = document.getElementById('name').value.trim();
            const customId = customIdInput.value.trim();

            if (!customId || !unit || !title || !name) {
                showAlert("請填寫所有欄位。");
                return;
            }

            if (customId !== currentCustomId) {
                currentCustomId = customId;
                displayCustomId.textContent = currentCustomId;
                if (isOnlineMode) {
                    startListeningForVisitors(currentCustomId);
                } else {
                    loadLocalData();
                }
            }

            if (isOnlineMode) {
                try {
                    const visitorsCollection = collection(db, `artifacts/${appId}/public/data/${currentCustomId}`);
                    await setDoc(doc(visitorsCollection), {
                        unit: unit,
                        title: title,
                        name: name,
                        timestamp: serverTimestamp(),
                        visited: false
                    });
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showAlert("提交時發生錯誤。");
                }
            } else {
                const newVisitor = {
                    id: Date.now().toString(),
                    unit,
                    title,
                    name,
                    timestamp: new Date().getTime(),
                    visited: false
                };
                visitorsData.push(newVisitor);
                saveLocalData();
                renderVisitors(visitorsData);
            }
            document.getElementById('unit').value = '';
            document.getElementById('title').value = '';
            document.getElementById('name').value = '';
        });

        // Add event listeners for the buttons
        downloadButton.addEventListener('click', downloadGuestList);
        resetButton.addEventListener('click', resetGuestList);

        // Start the application
        initializeFirebase();

    </script>
</body>
</html>
