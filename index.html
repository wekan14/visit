<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貴賓登記系統 (直接共編版)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .toast-message.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden md:flex">

        <!-- 左側：貴賓登記區 -->
        <div class="md:w-1/2 p-8 md:p-10 flex flex-col justify-center bg-gray-50 border-r border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">貴賓登記</h1>
            <p class="text-gray-500 mb-8 text-center">所有人的登記都會即時同步</p>
            
            <form id="registration-form" class="space-y-6">
                <div>
                    <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                    <input type="text" id="unit" required placeholder="例如：Google 台灣" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">職稱</label>
                    <input type="text" id="title" required placeholder="例如：軟體工程師" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="name" required placeholder="例如：王小明" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition-transform duration-200 transform hover:scale-105">
                    提交
                </button>
            </form>
        </div>

        <!-- 右側：貴賓列表與功能按鈕 -->
        <div class="md:w-1/2 p-8 md:p-10 bg-white">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center sm:text-left mb-4 sm:mb-0">即時貴賓列表</h2>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button id="download-list" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        下載名冊
                    </button>
                    <button id="reset-list" class="flex items-center justify-center bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        重設名單
                    </button>
                </div>
            </div>
            
            <!-- 貴賓列表容器 -->
            <div id="visitor-list" class="space-y-4">
                <p id="empty-list" class="text-gray-500 text-center">正在載入名單...</p>
            </div>
        </div>
    </div>

    <!-- 自定義彈窗，取代瀏覽器原生 alert 和 confirm -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-xs w-full mx-4 text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <!-- 按鈕將由 JS 動態生成 -->
            </div>
        </div>
    </div>

    <!-- 自定義訊息提示 -->
    <div id="toast" class="toast-message hidden"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, writeBatch, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Firestore 偵錯模式
        setLogLevel('debug');

        // 檢查全域變數並初始化
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        const form = document.getElementById('registration-form');
        const visitorList = document.getElementById('visitor-list');
        const emptyListMessage = document.getElementById('empty-list');
        const downloadButton = document.getElementById('download-list');
        const resetButton = document.getElementById('reset-list');
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        const toast = document.getElementById('toast');

        // 自定義彈窗函數
        function showCustomModal(message, type = 'alert', onConfirm = null) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            
            const okButton = document.createElement('button');
            okButton.textContent = '確定';
            okButton.className = 'px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors';
            okButton.onclick = () => {
                customModal.classList.add('hidden');
                if (type === 'confirm' && onConfirm) {
                    onConfirm(true);
                }
            };
            modalButtons.appendChild(okButton);

            if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.textContent = '取消';
                cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors';
                cancelButton.onclick = () => {
                    customModal.classList.add('hidden');
                    if (onConfirm) {
                        onConfirm(false);
                    }
                };
                modalButtons.appendChild(cancelButton);
            }

            customModal.classList.remove('hidden');
        }

        // 訊息提示函數
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // 建立貴賓列表項目
        function createVisitorItem(visitor) {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm';
            item.innerHTML = `
                <div>
                    <p class="text-sm font-semibold text-gray-800">${visitor.name}</p>
                    <p class="text-xs text-gray-500">${visitor.unit} - ${visitor.title}</p>
                </div>
            `;
            return item;
        }

        // 頁面加載時初始化
        window.onload = async () => {
            // 檢查 Firebase 設定是否存在
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase 設定資訊缺失。");
                showCustomModal("Firebase 設定資訊缺失，無法初始化應用程式。請聯繫支援團隊。");
                return;
            }

            try {
                // 初始化 Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 處理使用者認證
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 在認證完成後，才設定事件監聽器
                setupEventListeners();

            } catch (e) {
                console.error("應用程式初始化或資料庫連線失敗：", e);
                showCustomModal("應用程式初始化失敗。請檢查設定或稍後再試。");
            }
        };

        // 設置所有事件監聽器和資料庫監聽器
        function setupEventListeners() {
            // Firestore 監聽器
            const guestsCollection = collection(db, `artifacts/${appId}/public/data/guests`);
            const q = query(guestsCollection);
            onSnapshot(q, (snapshot) => {
                const guests = [];
                snapshot.forEach((doc) => {
                    guests.push(doc.data());
                });
                
                // 渲染列表
                visitorList.innerHTML = '';
                if (guests.length === 0) {
                    emptyListMessage.textContent = '目前還沒有貴賓登記。';
                    visitorList.appendChild(emptyListMessage);
                } else {
                    guests.forEach(guest => {
                        visitorList.appendChild(createVisitorItem(guest));
                    });
                }
            });

            // 提交表單
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const unit = form.unit.value;
                const title = form.title.value;
                const name = form.name.value;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/guests`), {
                        unit,
                        title,
                        name,
                        timestamp: new Date()
                    });
                    showToast("登記成功！");
                    form.reset();
                } catch (e) {
                    console.error("寫入文件時發生錯誤：", e);
                    showCustomModal("登記失敗。請稍後再試。");
                }
            });

            // 下載名冊為 CSV
            downloadButton.addEventListener('click', async () => {
                try {
                    const guestsRef = collection(db, `artifacts/${appId}/public/data/guests`);
                    const snapshot = await getDocs(guestsRef);
                    const guests = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        guests.push({
                            '單位': data.unit,
                            '職稱': data.title,
                            '姓名': data.name,
                            '登記時間': data.timestamp ? data.timestamp.toDate().toLocaleString() : 'N/A'
                        });
                    });

                    if (guests.length === 0) {
                        showCustomModal("名單是空的，無法下載。");
                        return;
                    }

                    const headers = Object.keys(guests[0]).join(',');
                    const rows = guests.map(g => Object.values(g).join(','));
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers, ...rows].join('\n');
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', 'guest_list.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast("名單已下載！");
                } catch (e) {
                    console.error("下載時發生錯誤：", e);
                    showCustomModal("下載名單失敗。");
                }
            });

            // 重設名單
            resetButton.addEventListener('click', async () => {
                showCustomModal("確定要永久刪除所有貴賓登記嗎？此操作不可逆轉！", 'confirm', async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            const guestsRef = collection(db, `artifacts/${appId}/public/data/guests`);
                            const snapshot = await getDocs(guestsRef);
                            
                            if (snapshot.size === 0) {
                                showCustomModal("名單已是空的。");
                                return;
                            }

                            const batch = writeBatch(db);
                            snapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            showToast("名單已成功重設！");
                        } catch (e) {
                            console.error("重設名單時發生錯誤：", e);
                            showCustomModal("重設名單失敗。請稍後再試。");
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
