<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è²´è³“ç™»è¨˜ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 sm:p-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6">è²´è³“ç™»è¨˜ç³»çµ±</h1>

    <!-- æ–°å¢è²´è³“ -->
    <form id="add-guest-form" class="space-y-4 mb-6">
      <input type="text" id="guest-company" placeholder="å…¬å¸/çµ„ç¹”" required class="w-full border px-4 py-2 rounded"/>
      <input type="text" id="guest-title" placeholder="è·ç¨±" required class="w-full border px-4 py-2 rounded"/>
      <input type="text" id="guest-name" placeholder="å§“å" required class="w-full border px-4 py-2 rounded"/>
      <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ç™»è¨˜è²´è³“</button>
    </form>

    <!-- æ§åˆ¶æŒ‰éˆ• -->
    <div class="flex justify-end space-x-4 mb-6">
      <button id="download-csv" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ä¸‹è¼‰æ¸…å–® (CSV)</button>
      <button id="reset-list" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">é‡ç½®æ¸…å–®</button>
    </div>

    <!-- è²´è³“æ¸…å–® -->
    <div id="loading" class="text-center text-gray-500">è¼‰å…¥è²´è³“æ¸…å–®...</div>
    <table id="guest-table" class="hidden min-w-full border">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">å…¬å¸/çµ„ç¹”</th>
          <th class="px-4 py-2 text-left">è·ç¨±</th>
          <th class="px-4 py-2 text-left">å§“å</th>
          <th class="px-4 py-2 text-left">æ™‚é–“</th>
          <th class="px-4 py-2 text-left">ç‹€æ…‹</th>
          <th class="px-4 py-2 text-left">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="guest-list"></tbody>
    </table>
  </div>

  <!-- Firebase & App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // ğŸ”‘ Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyBD_mfm8-WVLlOh2mTm5T4cIunQ_RgIB14",
      authDomain: "guest-91837.firebaseapp.com",
      projectId: "guest-91837",
      storageBucket: "guest-91837.firebasestorage.app",
      messagingSenderId: "746492623781",
      appId: "1:746492623781:web:b261acdae8f2485e24064c",
      measurementId: "G-SBDTZKPVJ2"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const guestListEl = document.getElementById("guest-list");
    const guestTable = document.getElementById("guest-table");
    const loading = document.getElementById("loading");
    const form = document.getElementById("add-guest-form");
    const resetBtn = document.getElementById("reset-list");

    let guestsData = [];

    // åŒ¿åç™»å…¥
    signInAnonymously(auth).then(() => console.log("åŒ¿åç™»å…¥æˆåŠŸ")).catch(console.error);

    // å³æ™‚ç›£è½è²´è³“æ¸…å–®
    const q = query(collection(db, "guests"));
    onSnapshot(q, (snapshot) => {
      guestsData = [];
      guestListEl.innerHTML = "";
      snapshot.forEach(docSnap => {
        const g = docSnap.data();
        guestsData.push({ id: docSnap.id, ...g });
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2">${g.company}</td>
          <td class="px-4 py-2">${g.title}</td>
          <td class="px-4 py-2">${g.name}</td>
          <td class="px-4 py-2">${g.time || ""}</td>
          <td class="px-4 py-2">
            ${g.introduced ? `<span class="text-green-600 font-bold">å·²ä»‹ç´¹</span>` :
            `<button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" data-id="${docSnap.id}">æ¨™è¨˜å·²ä»‹ç´¹</button>`}
          </td>
          <td class="px-4 py-2">
            <button class="text-red-600" data-id="${docSnap.id}">åˆªé™¤</button>
          </td>
        `;
        // åˆªé™¤
        tr.querySelector('button.text-red-600').addEventListener("click", async () => {
          await deleteDoc(doc(db, "guests", docSnap.id));
        });
        // æ¨™è¨˜å·²ä»‹ç´¹
        const markBtn = tr.querySelector('button[data-id]');
        if(markBtn) {
          markBtn.addEventListener("click", async () => {
            await updateDoc(doc(db, "guests", docSnap.id), { introduced: true });
          });
        }
        guestListEl.appendChild(tr);
      });
      loading.classList.add("hidden");
      guestTable.classList.remove("hidden");
    });

    // æ–°å¢è²´è³“
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const company = document.getElementById("guest-company").value;
      const title = document.getElementById("guest-title").value;
      const name = document.getElementById("guest-name").value;

      await addDoc(collection(db, "guests"), {
        company, title, name,
        introduced: false,
        time: new Date().toLocaleString("zh-TW"),
        timestamp: serverTimestamp()
      });

      form.reset();
    });

    // åŒ¯å‡º CSVï¼ˆUTF-8 BOM é¿å… Excel äº‚ç¢¼ï¼‰
    document.getElementById("download-csv").addEventListener("click", () => {
      if (!guestsData.length) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
        return;
      }
      const header = ["å…¬å¸/çµ„ç¹”", "è·ç¨±", "å§“å", "æ™‚é–“", "ç‹€æ…‹"];
      const rows = guestsData.map(g => [g.company, g.title, g.name, g.time, g.introduced ? "å·²ä»‹ç´¹" : "æœªä»‹ç´¹"]);
      let csvContent = "\uFEFF" + header.join(",") + "\n"
        + rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.setAttribute("download", "guests.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // é‡ç½®æ¸…å–®
    resetBtn.addEventListener("click", async () => {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è²´è³“è³‡æ–™å—ï¼Ÿ")) return;
      const qSnap = await getDocs(collection(db, "guests"));
      const batch = writeBatch(db);
      qSnap.forEach(d => batch.delete(d.ref));
      await batch.commit();
    });
  </script>
</body>
</html>
