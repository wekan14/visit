<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>貴賓登記系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 sm:p-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6">貴賓登記系統</h1>

    <!-- 新增貴賓 -->
    <form id="add-guest-form" class="space-y-2 mb-6">
      <input type="text" id="guest-company" placeholder="公司/組織" required class="w-full border px-3 py-1 rounded text-sm"/>
      <input type="text" id="guest-title" placeholder="職稱" required class="w-full border px-3 py-1 rounded text-sm"/>
      <input type="text" id="guest-name" placeholder="姓名" required class="w-full border px-3 py-1 rounded text-sm"/>
      <button type="submit" class="w-full py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">登記貴賓</button>
    </form>

    <!-- 控制按鈕 -->
    <div class="flex flex-col sm:flex-row justify-end sm:space-x-2 mb-6 space-y-1 sm:space-y-0">
      <button id="download-csv" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 w-full sm:w-auto text-sm">下載清單 (CSV)</button>
      <button id="reset-list" class="px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 w-full sm:w-auto text-sm">重置清單</button>
    </div>

    <!-- 載入中 -->
    <div id="loading" class="text-center text-gray-500">載入貴賓清單...</div>

    <!-- 卡片容器 -->
    <div id="guest-list" class="space-y-2 hidden"></div>

    <!-- 桌機表格 -->
    <div class="hidden sm:block overflow-x-auto">
      <table id="guest-table" class="min-w-full border table-auto text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-2 py-1 text-left">公司/組織</th>
            <th class="px-2 py-1 text-left">職稱</th>
            <th class="px-2 py-1 text-left">姓名</th>
            <th class="px-2 py-1 text-left">時間</th>
            <th class="px-2 py-1 text-left">狀態</th>
            <th class="px-2 py-1 text-left">操作</th>
          </tr>
        </thead>
        <tbody id="guest-table-body"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBD_mfm8-WVLlOh2mTm5T4cIunQ_RgIB14",
      authDomain: "guest-91837.firebaseapp.com",
      projectId: "guest-91837",
      storageBucket: "guest-91837.firebasestorage.app",
      messagingSenderId: "746492623781",
      appId: "1:746492623781:web:b261acdae8f2485e24064c",
      measurementId: "G-SBDTZKPVJ2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const guestListEl = document.getElementById("guest-list");
    const guestTableBody = document.getElementById("guest-table-body");
    const guestTable = document.getElementById("guest-table");
    const loading = document.getElementById("loading");
    const form = document.getElementById("add-guest-form");
    const resetBtn = document.getElementById("reset-list");

    let guestsData = [];

    signInAnonymously(auth).then(() => console.log("匿名登入成功")).catch(console.error);

    const q = query(collection(db, "guests"));
    onSnapshot(q, (snapshot) => {
      guestsData = [];
      snapshot.forEach(docSnap => guestsData.push({ id: docSnap.id, ...docSnap.data() }));

      guestsData.sort((a,b)=>{
        if(a.introduced === b.introduced) return a.timestamp?.seconds - b.timestamp?.seconds;
        return a.introduced ? 1 : -1;
      });

      renderGuests();
    });

    function renderGuests() {
      guestListEl.innerHTML = "";
      guestTableBody.innerHTML = "";

      guestsData.forEach(g => {
        // 卡片式（手機直屏）
        const card = document.createElement("div");
        card.className = "bg-white p-2 rounded shadow sm:hidden space-y-0.5 text-xs";
        card.innerHTML = `
          <div><strong>公司/組織:</strong> ${g.company}</div>
          <div><strong>職稱:</strong> ${g.title}</div>
          <div><strong>姓名:</strong> ${g.name}</div>
          <div><strong>時間:</strong> ${g.time}</div>
          <div>
            <strong>狀態:</strong> 
            ${g.introduced ? `<span class="text-green-600 font-bold">已介紹</span>` : `<button class="px-1 py-0.5 bg-red-500 text-white rounded hover:bg-red-600" data-id="${g.id}">未介紹</button>`}
          </div>
          <div>
            <button class="text-red-600 text-xs" data-id="${g.id}">刪除</button>
          </div>
        `;
        const delBtn = card.querySelector('button.text-red-600');
        delBtn?.addEventListener("click", async () => {
          if(!confirm(`確定要刪除 ${g.name} 的資料嗎？`)) return;
          await deleteDoc(doc(db, "guests", g.id));
        });
        const markBtn = card.querySelector('button[data-id]');
        if(markBtn){
          markBtn.addEventListener("click", async ()=>{
            await updateDoc(doc(db,"guests",g.id),{introduced:true});
          });
        }
        guestListEl.appendChild(card);

        // 桌機表格
        const tr = document.createElement("tr");
        tr.className = "hidden sm:table-row";
        tr.innerHTML = `
          <td class="px-2 py-1">${g.company}</td>
          <td class="px-2 py-1">${g.title}</td>
          <td class="px-2 py-1">${g.name}</td>
          <td class="px-2 py-1">${g.time || ""}</td>
          <td class="px-2 py-1">${g.introduced ? '<span class="text-green-600 font-bold">已介紹</span>' : `<button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" data-id="${g.id}">未介紹</button>`}</td>
          <td class="px-2 py-1"><button class="text-red-600" data-id="${g.id}">刪除</button></td>
        `;
        const delBtnTable = tr.querySelector('button.text-red-600');
        delBtnTable?.addEventListener("click", async () => {
          if(!confirm(`確定要刪除 ${g.name} 的資料嗎？`)) return;
          await deleteDoc(doc(db, "guests", g.id));
        });
        const markBtnTable = tr.querySelector('button[data-id]');
        if(markBtnTable){
          markBtnTable.addEventListener("click", async ()=>{
            await updateDoc(doc(db,"guests",g.id),{introduced:true});
          });
        }
        guestTableBody.appendChild(tr);
      });

      loading.classList.add("hidden");
      guestListEl.classList.remove("hidden");
      guestTable.classList.remove("hidden");
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const company = document.getElementById("guest-company").value;
      const title = document.getElementById("guest-title").value;
      const name = document.getElementById("guest-name").value;

      await addDoc(collection(db, "guests"), {
        company, title, name,
        introduced: false,
        time: new Date().toLocaleString("zh-TW"),
        timestamp: serverTimestamp()
      });
      form.reset();
    });

    document.getElementById("download-csv").addEventListener("click", ()=>{
      if(!guestsData.length){alert("目前沒有資料可以匯出"); return;}
      const header=["公司/組織","職稱","姓名","時間","狀態"];
      const rows=guestsData.map(g=>[g.company,g.title,g.name,g.time,g.introduced?"已介紹":"未介紹"]);
      let csv="\uFEFF"+header.join(",")+"\n"+rows.map(r=>r.map(v=>`"${v}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.setAttribute("download","guests.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    resetBtn.addEventListener("click", async ()=>{
      if(!confirm("確定要刪除所有貴賓資料嗎？")) return;
      const qSnap=await getDocs(collection(db,"guests"));
      const batch=writeBatch(db);
      qSnap.forEach(d=>batch.delete(d.ref));
      await batch.commit();
    });

  </script>
</body>
</html>
